<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <link rel="stylesheet" href="/api/leaflet_heatmap_files/example-commons.css">
  <link rel="stylesheet" href="/api/leaflet_heatmap_files/leaflet.css">
  <script src="/api/leaflet_heatmap_files/leaflet.js"></script>

  <style>
    .topButton {
      padding: 10px;
      display: flex;
      justify-content: space-around;
    }
  </style>
</head>
<body class="">
  <div class="topButton">
    <button class="button is-button is-primary" disabled>
      Voir la suite du trajet
    </button>
  </div>
  <div class="wrapper">
    <div class="demo-wrapper">
      <div class="heatmap leaflet-container leaflet-fade-anim" id="map-canvas" style="position: relative;" tabindex="0">
      </div>
    </div>
  </div>
  <div class="modal" id="modal">
    <div class="modal-background"></div>
    <div class="modal-content">
      Test
      <!-- Any other Bulma elements you want -->
    </div>
      <a href=".">
        <button class="button is-button is-primary">
          Nouvelle partie
        </button>
      </a>
  </div>
  <button type="button" onclick="startAnime()">Start</button>
  <script src="/api/leaflet_heatmap_files/heatmap.js"></script>
  <script src="/api/leaflet_heatmap_files/leaflet-heatmap.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  <script>
    let dirtyGlobal;
    let nextButton;
    let modal;

    var baseLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom: 18
      }
    );

    var cfg = {
      "radius": 2,
      "maxOpacity": .8,
      "scaleRadius": true,
      "useLocalExtrema": true,
      latField: 'lat',
      lngField: 'lng',
      valueField: 'count'
    };

    var heatmapLayer = new HeatmapOverlay(cfg);

    const GET_BACKEND_URL = () =>  `http://${window.location.hostname}:${window.location.port === "3000" ? "81" : window.location.port}/`;
    const Client = {
      GET: (uri) => fetch(GET_BACKEND_URL() + "api/" + uri)
    };

    document.addEventListener("DOMContentLoaded", () => {
      nextButton = document.getElementsByClassName("topButton")[0];
      modal = document.getElementById("modal");
      Client.GET("components").then((res1) => {
        res1.json().then((composants) => {
          console.log("Composants : ", composants);
          const urlParams = new URLSearchParams(window.location.search);
          Client.GET("gameresult/" + urlParams.get("gId")).then((res2) => {
            res2.json().then((gameResult) => {
                const userComposants = gameResult.componentIds.map(id => composants.find((c) => c._id === id));
                const allEtapes = userComposants.flatMap(composant => composant.etapesFabrication);
                const allGPS = allEtapes.flatMap(fab => ({idEtape: fab.idEtape, gps: fab.localisation.gps}))
                        .map(({idEtape, gps}) => ({lat: gps.x, lng: gps.y, count: 1, idEtape: idEtape}));

                console.log("Tous les points", allGPS);
                console.log("Componsants du joueur ", userComposants);
                console.log("Toutes les etapes des composants du joueur ", allEtapes);
                console.log("Resultat du jeu : ", gameResult);
                startMap(allGPS);
                dirtyGlobal = allGPS;
                console.log(nextButton.children);
                nextButton.children[0].disabled = false;
                nextButton.onclick = () => {
                  startAnime();
                  console.log("Clicked");
                  nextButton.children[0].disabled = true;
                  setTimeout(() => {
                    modal.className = modal.className + " is-active"
                  }, 7000);
                }
            });
          });
        });
      });
    });

    function startAnime()
    {
        let startPoint = dirtyGlobal.filter(p => p.idEtape === 1);

        var testData = {
            max: 99,
            data: startPoint
          };
        heatmapLayer.setData(testData);

        /*_*/endPoint = [{lat: 46.90, lng:-117.46, count: 1}, null, null];  //dirtyGlobal.filter(p => p.idEtape === 2);/*_*/

        var refreshIntervalId = setInterval(function() {
            var newData = [];

            for (var i = 0; i < startPoint.length; i++)
            {
              if (endPoint[i] != null)
              {
                if (Math.trunc(startPoint[i]['lat']) == Math.trunc(endPoint[i]['lat']) && Math.trunc(startPoint[i]['lng']) == Math.trunc(endPoint[i]['lng']))
                {
                  newData.push({lat: startPoint[i]['lat'], lng:startPoint[i]['lng'], count: 1});
                }
                else
                {
                  newVal = movePoint([startPoint[i]['lat'],startPoint[i]['lng']], [endPoint[i]['lat'],endPoint[i]['lng']], 1);
                  newData.push({lat: newVal[0], lng:newVal[1], count: 1});
                  startPoint[i]['lat'] = newVal[0];
                  startPoint[i]['lng'] = newVal[1];
                }
              }
              else
              {
                newData.push({lat: startPoint[i]['lat'], lng:startPoint[i]['lng'] , count: 1});
              }
            }


            var testData = {
                max: 99,
                data: newData
              };
            heatmapLayer.setData(testData);

          }, 10);
    };

    function movePoint(a, b, distance)
    {
      var vector = [(b[0] - a[0]), (b[1] - a[1])];
      var length = Math.sqrt(vector[0] * vector[0] + vector[1] * vector[1]);
      var unitVector = [(vector[0] / length), (vector[1] / length)];
      return [(a[0] + unitVector[0] * distance), (a[1] + unitVector[1] * distance)];
    };

    function startMap(pts) {
        var map = new L.Map('map-canvas', {
          center: new L.LatLng(0, 0),
          zoom: 3,
          layers: [baseLayer, heatmapLayer]
        });

        /*-*/startPoint = pts.filter(p => p.idEtape === 1);/*-*/

        var testData = {
            max: 99,
            data: startPoint
          };
        heatmapLayer.setData(testData);

        /*_*/endPoint = pts.filter(p => p.idEtape === 2);/*_*/
    };

  </script>

</body></html>